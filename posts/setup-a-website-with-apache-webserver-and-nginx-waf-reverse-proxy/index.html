<!DOCTYPE html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Set up website with apache webserver and nginx waf reverse proxy" /><meta name="author" content="WhiteBearVN" /><meta property="og:locale" content="en" /><meta name="description" content="When I started thinking about running my site on my own server instead of using Blogger or Medium, etc… And after tried to use Apache, Nginx,… I realized that combining Apache and Nginx could be the best choice for me, because I want to use .htaccess of Apache and speed of Nginx. There come my architecture:" /><meta property="og:description" content="When I started thinking about running my site on my own server instead of using Blogger or Medium, etc… And after tried to use Apache, Nginx,… I realized that combining Apache and Nginx could be the best choice for me, because I want to use .htaccess of Apache and speed of Nginx. There come my architecture:" /><link rel="canonical" href="https://blog.whitebear.vn/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/" /><meta property="og:url" content="https://blog.whitebear.vn/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/" /><meta property="og:site_name" content="WhiteBearVN" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-03T00:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Set up website with apache webserver and nginx waf reverse proxy" /><meta name="twitter:site" content="@WhiteBearVN_" /><meta name="twitter:creator" content="@WhiteBearVN" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"WhiteBearVN"},"dateModified":"2023-10-25T16:31:11+07:00","datePublished":"2020-04-03T00:00:00+07:00","description":"When I started thinking about running my site on my own server instead of using Blogger or Medium, etc… And after tried to use Apache, Nginx,… I realized that combining Apache and Nginx could be the best choice for me, because I want to use .htaccess of Apache and speed of Nginx. There come my architecture:","headline":"Set up website with apache webserver and nginx waf reverse proxy","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.whitebear.vn/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/"},"url":"https://blog.whitebear.vn/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/"}</script><title>Set up website with apache webserver and nginx waf reverse proxy | WhiteBearVN</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="WhiteBearVN"><meta name="application-name" content="WhiteBearVN"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/logo.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">WhiteBearVN</a></div><div class="site-subtitle font-italic">Thought on cyber security</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/WhiteBearVN" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/WhiteBearVN_" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['binhbear.vn','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Set up website with apache webserver and nginx waf reverse proxy</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Set up website with apache webserver and nginx waf reverse proxy</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1585846800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 3, 2020 </em> </span> <span> Updated <em class="" data-ts="1698226271" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 25, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="855 words"> <em>4 min</em> read</span></div></div></div><div class="post-content"><p>When I started thinking about running my site on my own server instead of using Blogger or Medium, etc… And after tried to use Apache, Nginx,… I realized that combining Apache and Nginx could be the best choice for me, because I want to use <code class="language-plaintext highlighter-rouge">.htaccess</code> of Apache and speed of Nginx. There come my architecture:</p><p><a href="/assets/img/blog/Diagram.jpg" class="popup img-link "><img data-src="/assets/img/blog/Diagram.jpg" alt="IMG" class="lazyload" data-proofer-ignore></a></p><p>In this post, I will use private IP range for Nginx reverse proxy server and Apache web server. Both of them are running Ubuntu 18.04 LTS.</p><ul><li><p>Apache webserver: 10.128.0.2</p><li><p>Nginx reverse proxy: 10.128.0.3</p></ul><h1 id="1-install-and-configure-apache-web-server">1. Install and configure Apache web server</h1><p>Install apache webserver:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>apache2
</pre></table></code></div></div><p>Next we create a place where to storage source code:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/www/html/example.com/public_html
</pre></table></code></div></div><p>Change permission:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo chown</span> <span class="nt">-R</span> &lt;user&gt;:&lt;group&gt; /var/www/html/example.com/public_html
<span class="nv">$ </span><span class="nb">sudo chmod</span> <span class="nt">-R</span> 744 /var/www/html/example.com/public_html
</pre></table></code></div></div><p>With <strong>user</strong> and <em>*group</em> you can use command</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>apachectl <span class="nt">-S</span>
</pre></table></code></div></div><p>Usually, it’s www-data</p><p>Now let’s config virutal host and port:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>vim /etc/apache2/ports.conf

Listen 8080

&lt;IfModule ssl_module&gt;
        Listen 443
&lt;/IfModule&gt;

&lt;IfModule mod_gnutls.c&gt;
        Listen 443
&lt;/IfModule&gt;

<span class="nv">$ </span><span class="nb">sudo cp</span> /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/example.com.conf
<span class="nv">$ </span><span class="nb">sudo </span>vim /etc/apache2/sites-available/example.com.conf

&lt;VirtualHost 10.128.0.2:8080&gt;
        ServerAdmin webmaster@example.com
        DocumentRoot /var/www/html/example.com/public_html/

        ErrorLog <span class="k">${</span><span class="nv">APACHE_LOG_DIR</span><span class="k">}</span>/error.log
        CustomLog <span class="k">${</span><span class="nv">APACHE_LOG_DIR</span><span class="k">}</span>/access.log combined
        ErrorDocument 404 /404.html
&lt;/VirtualHost&gt;
</pre></table></code></div></div><p>Active your website:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>a2dissite 000-default.conf
<span class="nv">$ </span><span class="nb">sudo </span>a2ensite example.com.conf
</pre></table></code></div></div><h1 id="2-install-and-configure-nginx">2. Install and configure Nginx</h1><h2 id="21-install-nginx-package"><span class="mr-2">2.1 Install Nginx package</span><a href="#21-install-nginx-package" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Install the prerequisites:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>curl gnupg2 ca-certificates lsb-release
</pre></table></code></div></div><p>Add repository for stable nginx packages:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"deb http://nginx.org/packages/ubuntu </span><span class="sb">`</span>lsb_release <span class="nt">-cs</span><span class="sb">`</span><span class="s2"> nginx"</span> <span class="se">\</span>
    | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/nginx.list
</pre></table></code></div></div><p>Import an official nginx signing key so apt could verify the packages authenticity:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://nginx.org/keys/nginx_signing.key | <span class="nb">sudo </span>apt-key add -
</pre></table></code></div></div><p>Verify that you now have the proper key:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt-key fingerprint ABF5BD827BD9BF62
</pre></table></code></div></div><p>The output should contain the full fingerprint 573B FD6B 3D8F BC64 1079 A6AB ABF5 BD82 7BD9 BF62 as follows:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>pub   rsa2048 2011-08-19 <span class="o">[</span>SC] <span class="o">[</span>expires: 2024-06-14]
      573B FD6B 3D8F BC64 1079  A6AB ABF5 BD82 7BD9 BF62
uid   <span class="o">[</span> unknown] nginx signing key &lt;signing-key@nginx.com&gt;
</pre></table></code></div></div><p>Finally, install Nginx:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt update
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>nginx
</pre></table></code></div></div><h2 id="22-configure-nginx-reverse-proxy"><span class="mr-2">2.2 Configure Nginx reverse proxy</span><a href="#22-configure-nginx-reverse-proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo cp</span> /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/example.com.conf
<span class="nv">$ </span><span class="nb">sudo </span>vim /etc/nginx/conf.d/example.com.conf
server <span class="o">{</span>

    listen       80<span class="p">;</span>
    server_name example.com<span class="p">;</span>
	port_in_redirect off<span class="p">;</span>

    location / <span class="o">{</span>
        proxy_redirect off<span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span>:<span class="nv">$server_port</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_pass http://10.128.0.2:8080<span class="p">;</span>
    <span class="o">}</span>

    location ~ /<span class="se">\.</span>ht <span class="o">{</span>
        deny  all<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="23-install-and-configure-modsecurity"><span class="mr-2">2.3 Install and configure Modsecurity</span><a href="#23-install-and-configure-modsecurity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Install the prerequisites:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> apt-utils autoconf automake build-essential git libcurl4-openssl-dev libgeoip-dev liblmdb-dev libpcre++-dev libtool libxml2-dev libyajl-dev pkgconf wget zlib1g-dev
</pre></table></code></div></div><p>Download Modsecurity source:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone <span class="nt">--depth</span> 1 <span class="nt">-b</span> v3/master <span class="nt">--single-branch</span> https://github.com/SpiderLabs/ModSecurity
</pre></table></code></div></div><p>Compile Modsecurity:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd </span>ModSecurity
<span class="nv">$ </span>git submodule init
<span class="nv">$ </span>git submodule update
<span class="nv">$ </span>./build.sh
<span class="nv">$ </span>./configure
<span class="nv">$ </span>make
<span class="nv">$ </span><span class="nb">sudo </span>make <span class="nb">install</span>
</pre></table></code></div></div><p>If you see this notification on your terminal, just ignore it and take a coffee because the process might take about 15 minutes to complete.</p><blockquote><p>fatal: No names found, cannot describe anything.</p></blockquote><h2 id="24-download-the-nginx-connector-for-modsecurity-and-compile-it-as-a-dynamic-module"><span class="mr-2">2.4 Download the NGINX Connector for ModSecurity and Compile It as a Dynamic Module</span><a href="#24-download-the-nginx-connector-for-modsecurity-and-compile-it-as-a-dynamic-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone <span class="nt">--depth</span> 1 https://github.com/SpiderLabs/ModSecurity-nginx.git
</pre></table></code></div></div><p>Check your nginx version:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nginx <span class="nt">-v</span>

nginx version: nginx/1.17.9
</pre></table></code></div></div><p>Download source code:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$ </span>wget http://nginx.org/download/nginx-1.17.9.tar.gz
<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xvzf</span> nginx-1.17.9.tar.gz
<span class="nv">$ </span><span class="nb">cd </span>nginx-1.17.9
<span class="nv">$ </span>./configure <span class="nt">--with-compat</span> <span class="nt">--add-dynamic-module</span><span class="o">=</span>../ModSecurity-nginx
<span class="nv">$ </span>make modules
<span class="nv">$ </span><span class="nb">sudo cp </span>objs/ngx_http_modsecurity_module.so /etc/nginx/modules/
</pre></table></code></div></div><p>Load Nginx Modsecurity Connector by add the load_module following to the top of <code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code></p><blockquote><p>load_module modules/ngx_http_modsecurity_module.so;</p></blockquote><p>Configure and Enable Modsecurity:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo mkdir</span> /etc/nginx/modsec
<span class="nv">$ </span><span class="nb">sudo </span>wget <span class="nt">-P</span> /etc/nginx/modsec/ https://raw.githubusercontent.com/SpiderLabs/ModSecurity/v3/master/modsecurity.conf-recommended
<span class="nv">$ </span><span class="nb">sudo mv</span> /etc/nginx/modsec/modsecurity.conf-recommended /etc/nginx/modsec/modsecurity.conf
</pre></table></code></div></div><p>Active dropping malicious mode:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'s/SecRuleEngine DetectionOnly/SecRuleEngine On/'</span> /etc/nginx/modsec/modsecurity.conf
</pre></table></code></div></div><p>Add modsecurity rule and config your test rule:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>vim /etc/nginx/modsec/main.conf

Include <span class="s2">"/etc/nginx/modsec/modsecurity.conf"</span>

<span class="c"># Basic test rule</span>

SecRule ARGS:testparam <span class="s2">"@contains test"</span> <span class="s2">"id:1234,deny,status:403"</span>
</pre></table></code></div></div><p>Then turn on the modsecurity in your server config:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>vim /etc/nginx/conf.d/example.com.conf

server <span class="o">{</span>
    <span class="c"># ...</span>
    modsecurity on<span class="p">;</span>
    modsecurity_rules_file /etc/nginx/modsec/main.conf<span class="p">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Check everything ok yet by command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>nginx <span class="nt">-t</span>
</pre></table></code></div></div><p>If the output are:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</pre></table></code></div></div><p>We completed 99%, if there is an error about unicode.mapping, you can fix it by the following commands:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd</span> /path/to/Modsecurity
<span class="nv">$ </span><span class="nb">sudo cp </span>unicode.mapping /etc/nginx/modsec/
</pre></table></code></div></div><p>Check if the waf is active or not by curl. The <code class="language-plaintext highlighter-rouge">403</code> status confirmed that the rule worked:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$ </span>curl example.com/?testparam<span class="o">=</span><span class="nb">test</span>
&lt;html&gt;
&lt;<span class="nb">head</span><span class="o">&gt;</span>&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">"white"</span><span class="o">&gt;</span>
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.17.9&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></table></code></div></div><p>This is the basic configuration, if you have any problem, just let me know and I will help you!</p><p>Cheers!</p><p>P/S: Thank you GinaTU aka Tứ Diệp Thảo to help me edit this post</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/research/'>Research</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/nginx/" class="post-tag no-text-decoration" >nginx</a> <a href="/tags/forensics/" class="post-tag no-text-decoration" >forensics</a> <a href="/tags/apache/" class="post-tag no-text-decoration" >apache</a> <a href="/tags/webserver/" class="post-tag no-text-decoration" >webserver</a> <a href="/tags/system/" class="post-tag no-text-decoration" >system</a> <a href="/tags/waf/" class="post-tag no-text-decoration" >waf</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Set%20up%20website%20with%20apache%20webserver%20and%20nginx%20waf%20reverse%20proxy%20-%20WhiteBearVN&url=https%3A%2F%2Fblog.whitebear.vn%2Fposts%2Fsetup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Set%20up%20website%20with%20apache%20webserver%20and%20nginx%20waf%20reverse%20proxy%20-%20WhiteBearVN&u=https%3A%2F%2Fblog.whitebear.vn%2Fposts%2Fsetup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Set%20up%20website%20with%20apache%20webserver%20and%20nginx%20waf%20reverse%20proxy%20-%20WhiteBearVN&url=https%3A%2F%2Fblog.whitebear.vn%2Fposts%2Fsetup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/setup-a-website-with-apache-webserver-and-nginx-waf-reverse-proxy/">Set up website with apache webserver and nginx waf reverse proxy</a><li><a href="/posts/Writeup-VNPT-Secathon-2018/">[Writeup] VPNT Secathon 2018 - Misc</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/cryptography/">cryptography</a> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/apache/">apache</a> <a class="post-tag" href="/tags/asis/">ASIS</a> <a class="post-tag" href="/tags/bsides/">BSides</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Writeup-BSides-Noida-CTF-2021-Deathnote/"><div class="card-body"> <em class="small" data-ts="1628355600" data-df="ll" > Aug 8, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Writeup] BSides Noida CTF 2021 - Deathnote</h3><div class="text-muted small"><p> Bài này cho chúng ta 1 vuln box trên tryhackme và nhiệm vụ là phải cat được flag trong root folder. Đầu tiên, mình dùng nmap để xem các port đang mở trên box này. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 ...</p></div></div></a></div><div class="card"> <a href="/posts/Writeup-VNPT-Secathon-2018/"><div class="card-body"> <em class="small" data-ts="1521478800" data-df="ll" > Mar 20, 2018 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Writeup] VPNT Secathon 2018 - Misc</h3><div class="text-muted small"><p> Chayngaydi Trong bài này ban tổ chức cho chúng ta đoạn teaser trailer Chạy ngay đi của Sếp. Ngay khi nhìn vào dung lượng của tập tin mp4, thì mình biết chắc chắn rằng nó đang giấu một file gì đ...</p></div></div></a></div><div class="card"> <a href="/posts/Mates-SS2-Round-4-Forensics-caigidzay/"><div class="card-body"> <em class="small" data-ts="1525107600" data-df="ll" > May 1, 2018 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Writeup] Mates SS2 Round 4 - Forensics caigidzay</h3><div class="text-muted small"><p> Trong thử thách này để bài là một file dump, mbr/dos nên mình sẽ dùng auto spy để mở nó xem sao. Đập vào mắt mình là flag.jpg. Mình tốn kha khá thời gian với bức ảnh này vì lúc đầu tưởng đây là ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Writeup-BSidesSF-2019-CTF/" class="btn btn-outline-primary" prompt="Older"><p>[Writeup] BSidesSF 2019 CTF</p></a> <a href="/posts/Hexion-CTF-2020/" class="btn btn-outline-primary" prompt="Newer"><p>[Writeup] Hexion CTF 2020</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/research/">research</a> <a class="post-tag" href="/tags/cryptography/">cryptography</a> <a class="post-tag" href="/tags/hackthebox/">hackthebox</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/apache/">apache</a> <a class="post-tag" href="/tags/asis/">ASIS</a> <a class="post-tag" href="/tags/bsides/">BSides</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/WhiteBearVN_">WhiteBearVN</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/mermaid@9.2.2/dist/mermaid.min.js"></script> <script> (function () { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE ? "dark" : "default"); let config = {theme: expectedTheme}; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function () { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Create mermaid tag */ $("pre").has("code.language-mermaid").each(function () { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<pre class=\"mermaid\">${svgCode}</pre>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); })(); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { /* start/end delimiter pairs for in-line math */ inlineMath: [ ['$', '$'], ['\\(', '\\)'] ], /* start/end delimiter pairs for display math */ displayMath: [ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
